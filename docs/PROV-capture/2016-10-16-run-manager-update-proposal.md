# Proposed Run Manager Updates

The Run Manager (RM) currently records provenance data for single executions, and can include these
data with data package uploads to DataONE member nodes. In addition, information for files
that are used or generated by script executions is also recorded, such as checksum, file creation date, etc.

The file and provenance data will be used together to expand the use of provenance data to describe and
visualize multiple executions that are related and comprise a data processing workflow.

## 1. Tracing Execution Workflow Provenance
A simple workflow may involve multiple processing steps, where each step is a script execution.
For example, a workflow may include a data acquisition step (downloading data from DataONE),
a data cleaning step, a data processing step and a data visualization step. Files generated by one step are input to the next
step in the workflow. The files that are common between script executions are identified by a digital signature such as a SHA-256 hash. Using the files common between executions, the execution generating the file can be linked
to the execution using the file. By using this method, information for an entire execution workflow can be retrieved.

### 1.1 Use Cases For Execution Workflow Traces
A new use case 42C “Trace Execution Workflow" will be added to the provenance use cases. This new use case is related to use case 42 “Track Run History” which details how “Scientists can track, list and examine script executions”. Use case 42C will describe how each execution in a workflow is run, then an execution workflow trace is performed to retrieve provenance information for all executions that comprise the workflow.

Use case 43 "Publish to DataONE" ("Scientists can publish derived datasets and tracking information to DataONE") will be expanded to include publishing all executions in a workflow to DataONE.

Use case 47A "Visualize Execution Workflow" will be added to describe how an execution workflow can be visualized. The `plotwf` command will be written to view an execution workflow trace.

### 1.2 Run Manager `trace` command

The command ‘trace’ will be added to RM to trace provenance across multiple executions. Here is an example `trace` command:

```
wftrace <- trace(start=1234, direction="backward", as="RDF/XML")
```

In this example, the trace begins at the execution with sequence number "1234", proceeds in
a chronologically "backward" direction, and outputs provenance as an "RDF/XML" graph.

The trace command will start a provenance trace given an object’s id. The arguments
are:
- start: an object identifier (file or execution), or an execution sequence number to start the trace from. If the
  argument is a numeric it is interpreted as a sequence number, if it is a character string, it is interpreted as
  an object id (for example an execution id or file id).
- direction: trace provenance in either a forward, backward, or both drections (default is backward). The direction   indicates the chronological direction in which proceed with the trace, e.g. forward in time or backward in time.
- traversalLevel: trace n number of linked executions away from the starting execution. This
  is in effect specifies a condition for completing the trace. If not specified, then all executions
  in a workflow are retrieved.
- as: output the graph as one of the following formats "RDF/XML" (default) or "data.frame".

### 1.3 Run Manager `viewRuns` command

The command `viewRuns` will be updated to allow sequentially viewing each execution in an
execution workflow. Here is how the `viewRuns` command changes would be used in the R
environment:

```
rc <- new("Recordr")
wftrace <- trace(start=1234, as=data.frame)
viewRuns(rc, worflow=wftrace)
```

In this example, a workflow trace is retrieved starting at execution with sequence number 1234,
and the result data.frame is passed to `viewRuns` to view details of each execution in the workflow.

### 1.4 Run Manager `viewwf` command

The command `viewWF` (view workflow, can anyone suggest a better name?) will be added to RM and will be used to visualize an execution
workflow trace. The `viewWF` will create a network diagram, as libraries to create these
types of diagrams are available in R (igraph) and MATLAB (digraph).

The following commands will create a network graph of a workflow:
```
rc <- new("Recordr")
wftrace <- trace(start=1234, as=data.frame)
viewWF(rc, worflow=wftrace)
```

As an alternative, users may wish to export an RDF/XML workflow trace to a full featured graphics packages
such as [RDF Gravity](http://semweb.salzburgresearch.at/apps/rdf-gravity/index.html), [VUE](http://vue.tufts.edu/) or Graphviz, etc.

### 1.5 Potential problems with workflow tracing
Although the SHA 256 checksum algorithm provides a very high degree of uniqueness when used as a digital signature for a file, there may still be problems associated with linking executions based on it.

#### 1.5.1 Checksum not unique
For example, an example script that generates an output file `clean.R` might generate an output file `cleanData.csv` that is identical for many runs of the script. A different script `process.R` that runs later in the workflow reads `cleanData.csv`. For our example, let's say that `process.R` only ran once. When the trace is done, it is unclear which execution of ‘clean.R’ to link the execution of ‘process.R’. It might be possible to use anxiliary information such as script execution start and end times reduce the number of multiple hits.

#### 1.5.2 Modifying Files Outside An Execution
A workflow may include steps that involve manually editing files, for example a data cleaning step
might involve manually editing a CSV file which changes the checksum of the file, thereby 'breaking'
the provenance tracing based on file checksum. The provenance could be 'mended' by a new RM command
`addRelationship` (see below).

#### 1.5.3 Potentially Expensive Workflow Traces
The provenance data is stored by the RM in a relational database, so the trace command must recursively build the graph that represents the lineage trace. This may involve multiple queries as the graph is being built, which will reduce performance of the command.

## 2.  Manual entry of provenance relationships

It may become necessary to manually add provenance relationships that are not captured by the RM
such as the case for manually editing files that break a provenance workflow mentioned earlier, or
for file types that are not being traced by the RM for which a user wishes to assert provenance
relationships for.

### 2.1 Run Manager `addRelationship` Command

The `addRelationship` command will be added to the RM to allow for manually adding provenance relationships to an execution. Note that both the DataONE Java client library and the R `datapack` package have an `insertRelationship` function that allows adding provenance relationships to a data package.

The RM `addRelationship` function however will add a provenance relationship to a script execution, and not directly to a data package. The RM will call the `insertRelationships` function when it is transferring provenance to a data package as is the case when the `publish` function is called to upload a script execution to DataONE.

An example `addRelationship` invocation in the R environment:

```
rc <- new("Recordr")
addRelationship(rc,
  id=1234,
  subjectID="urn:uuid:9063FE19-D99A-4263-8020-8D3A9D45F9E9",
  objectID="urn:uuid:FB18E8A3-E8DA-4840-ABDE-526F138A9C6F",
  predicate="http://www.w3.org/ns/prov#used")
```
The `addRelationship` arguments are:
- id: the execution identifier or sequence number to add the relationship to
- subjectdId: the subject of the relationship
- objectId: the object of the relationship
- predicate: the predicate of the relationship
