---
title: "Using Processing Provenance"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Record script exectutions in multi-step processing
A processing pipeline may involve multiple scripts, each of which performs a processing step
that reads files generated from a previous step and generates files that will
be used by the next step. The R recordr package can record information for each
step in a multi-step pipeline and then later retrieve information about the
entire pipeline. 

The example pipeline shown below contains three processing steps, with each step
implemented by an R script. Each step is run and recorded using the
recordr `record()` method:

```
rc <- new("Recordr")
record(rc, "get_analysis_rasters.R", tag="process rasters")
record(rc, "lsp_zonal_stats.R", tag="lsp zonal stats")
record(rc, "summarize_zonal_stats.R", tag="get rasters")

``` 
The `record` command captures information about files that were used or generated by 
each script. This information is retrieved and used to display or perform operations
on the complete, using these recordr commands:

- `listRuns`: create a summary list of all runs 
- `viewRun`: display details information about all runs 
- `graphRun`: create a graph that shows all the runs and the files that connect them
- `publishRuns`: publish all runs in a processing pipeline

## List Scripts Of a Processing Pipeline

To illustrate retrieving information for a specific processing pipeline vs other runs, a script
unrelated to the above pipeline will be run:

```
record(rc, "EMCoverage.R", tag="first coverage run")
```

The 'listRuns' command is used to show all script executions that have been recorded with the `record` method.
By default, all script runs are show, regardless of connections to other scripts and are listed in reverse 
chronological order:
```
listRuns(rc)

Seq   Script                          Tag                        Start Time              Run Id        Published Time
4     EmCoverage.R                    forth coverage test        2017-03-01 15:53:08 PST ...2e94aa9f49 NA            
3     summarize_zonal_stats.R         summarize zonal stats      2017-04-30 12:41:30 PDT ...b92a5bc6e1 NA            
2     lsp_zonal_stats.R               lsp zonal stats            2017-04-28 12:41:28 PDT ...9317a45564 NA            
1     get_analysis_rasters.R          process rasters            2017-04-26 12:41:12 PDT ...e7c8fa91f7 NA

```

Next, the `listRuns` command will be used to retrieve and show only scripts that are steps in the example pipeline.
Following the connections of common files between script runs is known as performing a data processing provenance trace.
In order to perform a trace and not simply a chronological list, the `direction` parameter is used, and in the following
example the value `forward` is used to indicate that the trace proceeds toward derivations or descendants.
The staring location of the trace is indicated using the `seq` or `id` parameters to specify the run to start from:

```
listRuns(rc, seq=1, direction="forward")

Seq   Script                          Tag                        Start Time              Run Id        Published Time
3     summarize_zonal_stats.R         ohi, summarize zonal stats 2017-04-30 12:41:30 PDT ...b92a5bc6e1 NA            
2     lsp_zonal_stats.R               ohi, lsp zonal stats       2017-04-28 12:41:28 PDT ...9317a45564 NA            
1     get_analysis_rasters.R          ohi, get reasters, ohibc   2017-04-26 12:41:12 PDT ...e7c8fa91f7 NA
```
The run for script 'EmCoverage.R' was not displayed, because there are no common files between this script and
the other scripts that have been recorded.

As the trace proceeds, each ancestore or descendant encounted is considered a "step", analogous to a
"generation" in geneology. The example pipeline then has three steps, corresponding to the three
scripts that were run and recorded.

A portion of the trace can be retrieved and displayed using the `steps` parameter:
```
listRuns(rc, seq=1, direction="forward", steps=1)

Seq   Script                          Tag                        Start Time              Run Id        Published Time
2     lsp_zonal_stats.R               ohi, lsp zonal stats       2017-04-28 12:41:28 PDT ...9317a45564 NA            
1     get_analysis_rasters.R          ohi, get reasters, ohibc   2017-04-26 12:41:12 PDT ...e7c8fa91f7 NA
```

## View Runs Of A Pipeline

Detailed listings for each run in a trace can be viewed using the same arguments for listRuns.
The following command will retrieve all linked runs and display each run 
```
viewRuns(rc, seq=1, direction="forward")o

[details]: Run details
----------------------
“/Users/slaughter/R/x86_64-darwin-...y/OHI-Scienct/setup_watershed_raster.R” was executed on 2017-04-26 10:41:15 PST
Tag: “ohi, setup”
Run sequence #: 1
Publish date: Not published
Published to: NA
Published Id: NA
View at: NA
Run by user: slaughter
Account subject: NA
Run Id: urn:uuid:cfca952c-16f1-4e41-b022-1b4496098d
Data package Id: urn:uuid:2d2420c4-3fb4-4dce-b299-131d10851753
HostId: Peters-MBP.domain
Operating system: x86_64-apple-darwin13.4.0
R version: R version 3.3.2 (2016-10-31)
Dependencies: stats, graphics, grDevices, utils, datasets, methods, base, hash_2.2.6, Rcpp_0.12.9, knitr_1.15.1, magrittr_1.5, roxygen2_5.0.1, rappdirs_0.3.1, munsell_0.4.3, uuid_0.1-2, colorspace_1.3-2, R6_2.2.0, stringr_1.2.0, httr_1.2.1, plyr_1.8.4, tools_3.3.2, grid_3.3.2, redland_1.0.17-9, gtable_0.2.0, parsedate_1.1.1, DBI_0.5-1, htmltools_0.3.5, assertthat_0.1, lazyeval_0.2.0, yaml_2.1.14, rprojroot_1.2, digest_0.6.12, tibble_1.2, base64enc_0.1-3, datapack_1.1.0.9000, evaluate_0.10, memoise_1.0.0, RSQLite_1.1-2, rmarkdown_1.3, stringi_1.1.2, scales_0.4.1, backports_1.0.5, XML_3.98-1.5, jsonlite_1.2, ggplot2_2.2.1, recordr_1.0.3.9000, EML_1.0.1.1, dataone_2.0.1.9000
Run start time: 2017-04-26 10:41:15 PST
Run end time: 2017-04-26 10:41:48 PST

[used]: 1 items used by this run
-----------------------------------
Location                                                     Size (kb)    Modified time      
/Users/slaughter/R/x86_64-da...tdata/OHI-Science/ohibc_rgn_raster_500m.tif 138365       2017-02-25 14:58:19

[generated]: 1 items generated by this run
-----------------------------------------
Location                                                     Size (kb)    Modified time      
/private/var/folders/zb/y107...gGjbo/OHI-Science/howe_sound_watershed_500m.tif 8052         2017-02-26 10:41:48
enter <return> to view next run, or "q"<return> to quit.

```

## Graph A Processing Pipeline

The entire pipeline can be viewed graphically using the `graphRuns` command. This command begins the trace at the
specified run (`seq=1`) proceeds in both a forward and reverse direction. A forward
search causes the trace to proceed to runs that are descendants of the current run.  For a forward search,
each file generated by a run is inspected and runs that used the file are considered for inclusion in the trace
as potential descendants. A reverse search looks for ancestores of the current execution. 
These two trace
methods can be combined by specifying a trace direction of "both".

A graphical view of the processing workflow can be viewed using the plotRuns command.
```
graphRuns(rc, seq=2, direction="forward")
```

![Provenance trace example.](https://github.com/DataONEorg/sem-prov-design/raw/master/docs/PROV-capture/traceGraph.png)
## Publish Runs From a Pipeline
Runs from a pipeline can be published to a repository using the `publishRuns` command. In the following example
the `publishRuns` command arguments that are used perform the same provenance trace as the `graphRuns` command shown earlier,
so that all runs for the example pipeline are published. By default, these runs are published in one package:
```
publishRuns(rc, seq=1, direction="forward", quiet=FALSE, combineRuns=FALSE)

Publishing all runs in a single package:
  Including run "...b92a5bc6e1" (ohi, summarize zonal stats) to https://mn-dev.ucsb-1.test.dataone.org
  Including run "...9317a45564" (ohi, lsp zonal stats) to https://mn-dev.ucsb-1.test.dataone.org
  Including run "...e7c8fa91f7" (ohi, get reasters, ohibc) to https://mn-dev.ucsb-1.test.dataone.org
Published package with identifier "7b49a634-6090-47ec-8f26-83c38aea2bc6" to https://mn-dev-ucsb-1.test.dataone.org
```
Alternatively, all runs can be published into separate packages for each run by using the `combineRuns`
parameter.
```
publishRuns(rc, seq=1, direction="forward", quiet=FALSE, combineRuns=FALSE)

Published run "...b92a5bc6e1" (summarize zonal stats) with identifier "a778203a-4fdd-4286-947d-0fd1cacaf67f" to https://mn-dev-ucsb-1.test.dataone.org
Published run "...9317a45564" (lsp zonal stats) to with identifier "0a35a56f-1967-46f1-8266-2bea379137a4" to https://mn-dev-ucsb-1.test.dataone.org
Published run "...e7c8fa91f7" (get reasters, ohibc) with identifeir "8f783aef-fa40-47c7-8b5b-cedc7f3d5f9e" to https://mn-dev-ucsb-1.test.dataone.org
```
